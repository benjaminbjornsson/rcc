name: Build & Test

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      TEST_SCRIPT: writing-a-c-compiler-tests/test_compiler
      TEST_SCRIPT_ARGS: --chapter 1
      COMPILER_DRIVER: target/debug/rcc

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install GCC toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config
          gcc --version

      - name: Set up Python (>=3.10)
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Verify Python version
        run: python -c "import sys; assert sys.version_info >= (3,10), sys.version"

      - name: Set up Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cargo build
        run: cargo build --locked --verbose

      - name: Cargo test
        run: cargo test --locked --verbose

      - name: Run end-to-end Python test
        run: python $TEST_SCRIPT $TEST_SCRIPT_ARGS $COMPILER_DRIVER
